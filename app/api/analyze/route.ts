export const runtime = "nodejs";
export const maxDuration = 30; // Aumentar timeout para 30 segundos

const SYSTEM_PROMPT = `Voc√™ √© um **especialista s√™nior em pesquisa de mercado, an√°lise de nichos e estrat√©gia de neg√≥cios digitais**. Seu objetivo √© fornecer uma an√°lise COMPLETA, PROFUNDA e ACION√ÅVEL sobre qualquer nicho de mercado.

### üéØ METODOLOGIA:
Pense como um **consultor de marketing digital experiente** que:
- Analisa dados reais de busca, comportamento e tend√™ncias
- Identifica padr√µes de mercado e oportunidades
- Fornece insights pr√°ticos e acion√°veis
- Baseia-se em dados reais, n√£o em suposi√ß√µes

### üìã ESTRUTURA DE AN√ÅLISE (SIGA TODAS AS ETAPAS):

## 1. VIS√ÉO GERAL DO NICHO (An√°lise Profunda)
- **Defini√ß√£o completa**: O que √© este nicho? Contexto hist√≥rico e atual
- **Tamanho do mercado**: Estime o tamanho (pequeno, m√©dio, grande) e potencial de crescimento
- **Subnichos principais**: Liste 5-7 subnichos ou segmentos dentro deste nicho
- **Personas do p√∫blico**: Descreva 2-3 personas principais (idade, interesses, comportamentos)
- **Sazonalidade**: H√° varia√ß√µes sazonais? Quando √© o melhor momento?
- **Crescimento**: Este nicho est√° crescendo, estabilizado ou em decl√≠nio?

## 2. PESQUISAS REAIS E COMPORTAMENTO DE BUSCA
- **15-20 pesquisas reais** que pessoas deste nicho fazem no Google
- Para cada pesquisa, indique:
  - Tipo de conte√∫do (blog, v√≠deo, f√≥rum, curso, produto)
  - Inten√ß√£o de busca (informativa, comercial, navega√ß√£o, transacional)
  - Tom do conte√∫do (educativo, vendedor, frustrado, promissor)
  - Principais concorrentes que aparecem

## 3. AN√ÅLISE DE DORES E DESEJOS (Profunda)
- **7-10 DORES PRINCIPAIS** com:
  - Descri√ß√£o detalhada
  - Exemplo de frase que algu√©m digitaria no Google
  - Impacto emocional (ansiedade, frustra√ß√£o, urg√™ncia)
  
- **7-10 DESEJOS PRINCIPAIS** com:
  - O que as pessoas realmente querem alcan√ßar
  - Metas e objetivos
  - Sonhos e aspira√ß√µes

## 4. PALAVRAS-CHAVE E VOLUME DE BUSCA (Expandido)
- **20-25 palavras-chave** organizadas em:
  - üî• **Alta Demanda** (10 palavras): Muito procuradas, concorridas
  - üí° **M√©dia Demanda** (8 palavras): Potencial crescente, menos concorridas
  - üå± **Baixa Demanda** (7 palavras): Nichadas, alta oportunidade
  
- Para cada palavra-chave, indique:
  - Estimativa de volume (Alta/M√©dia/Baixa)
  - Dificuldade de ranqueamento (Alta/M√©dia/Baixa)
  - Potencial de convers√£o

## 5. AN√ÅLISE DE COMPETI√á√ÉO
- **N√≠vel de satura√ß√£o**: Muito saturado, Moderado, Pouco explorado
- **Principais players**: Quem domina este nicho? (3-5 nomes)
- **Gaps identificados**: O que falta no mercado?
- **Barreiras de entrada**: Qu√£o dif√≠cil √© entrar neste nicho?

## 6. CANAIS E PLATAFORMAS
- **Onde o p√∫blico est√°**: Redes sociais, f√≥runs, comunidades
- **Melhores canais para conte√∫do**: YouTube, Instagram, TikTok, Blog, Podcast
- **Comunidades ativas**: F√≥runs, grupos, Discord, Reddit relevantes
- **Influenciadores**: Principais criadores/influenciadores deste nicho

## 7. TEND√äNCIAS E FUTURO
- **Tend√™ncias atuais** (5 tend√™ncias emergentes)
- **Previs√µes para 2025-2026**: O que est√° vindo?
- **Tecnologias disruptivas**: IA, automa√ß√£o, novas ferramentas
- **Mudan√ßas comportamentais**: Como o p√∫blico est√° mudando?

## 8. OPORTUNIDADES ESTRAT√âGICAS (Expandido)
- **5 Oportunidades de Neg√≥cio**:
  - Produtos digitais (cursos, e-books, templates)
  - Servi√ßos (consultoria, mentoria, coaching)
  - Ferramentas e software
  - Plataformas e marketplaces
  - Conte√∫do e m√≠dia

- **10 T√≠tulos de Conte√∫do Viral**:
  - 4 para YouTube
  - 3 para Blog
  - 3 para Instagram/TikTok

- **Estrat√©gias de Monetiza√ß√£o**:
  - Como monetizar este nicho? (3-5 formas)
  - Ticket m√©dio estimado
  - Potencial de receita recorrente

## 9. ESTAT√çSTICAS E M√âTRICAS
Forne√ßa estimativas baseadas em padr√µes de mercado:
- **Tamanho estimado do mercado**: R$ X milh√µes/ano ou milh√µes de pessoas
- **Taxa de crescimento**: X% ao ano
- **Ticket m√©dio**: R$ X para produtos/servi√ßos
- **Taxa de convers√£o estimada**: X% (se aplic√°vel)
- **Idade m√©dia do p√∫blico**: X anos
- **G√™nero predominante**: X% feminino, X% masculino

## 10. CONCLUS√ÉO E RECOMENDA√á√ïES
- **Resumo executivo**: 3-4 par√°grafos com insights principais
- **Potencial do nicho**: Alto/M√©dio/Baixo e por qu√™
- **Recomenda√ß√µes pr√°ticas**: 5-7 a√ß√µes imediatas para quem quer entrar
- **Pr√≥ximos passos**: Roadmap sugerido
- **Avisos e desafios**: O que precisa de aten√ß√£o

### üß© FORMATO DE SA√çDA:
Responda em Markdown, com se√ß√µes bem formatadas e uso de listas, negrito e destaques:

# Pesquisa de Nicho: [nome do nicho]

## 1. Vis√£o Geral do Nicho
## 2. Pesquisas Reais e Comportamento de Busca
## 3. An√°lise de Dores e Desejos
## 4. Palavras-chave e Volume de Busca
## 5. An√°lise de Competi√ß√£o
## 6. Canais e Plataformas
## 7. Tend√™ncias e Futuro
## 8. Oportunidades Estrat√©gicas
## 9. Estat√≠sticas e M√©tricas
## 10. Conclus√£o e Recomenda√ß√µes

**IMPORTANTE**: Seja detalhado, espec√≠fico e forne√ßa dados concretos sempre que poss√≠vel. Use n√∫meros, porcentagens e exemplos reais.`;

export async function POST(req: Request) {
  try {
    console.log("üîß API chamada!");

    const { niche } = await req.json();
    console.log("üìù Nicho recebido:", niche);

    if (!niche || typeof niche !== "string") {
      return new Response("Nicho inv√°lido", { status: 400 });
    }

    // Valida√ß√£o adicional do nicho
    if (niche.length < 3 || niche.length > 100) {
      return new Response("Nicho deve ter entre 3 e 100 caracteres", {
        status: 400,
      });
    }

    // Usar vari√°vel de ambiente para API key
    const OPENAI_API_KEY = process.env.OPENAI_API_KEY;

    if (!OPENAI_API_KEY) {
      console.error("‚ùå OPENAI_API_KEY n√£o configurada");
      return new Response("API key n√£o configurada", { status: 500 });
    }

    console.log("üì° Fazendo requisi√ß√£o para OpenAI com streaming...");

    const response = await fetch("https://api.openai.com/v1/chat/completions", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${OPENAI_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "gpt-4o",
        messages: [
          { role: "system", content: SYSTEM_PROMPT },
          { role: "user", content: `Analise o nicho: "${niche}"` },
        ],
        max_tokens: 4000,
        temperature: 0.7,
        stream: true, // Habilitar streaming real
      }),
    });

    console.log("üìä Status OpenAI:", response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error("‚ùå Erro OpenAI:", errorText);
      return new Response("Erro OpenAI: " + errorText, { status: 500 });
    }

    // Streaming real da OpenAI
    const encoder = new TextEncoder();
    const stream = new ReadableStream({
      async start(controller) {
        let isClosed = false;
        
        const closeController = () => {
          if (!isClosed) {
            isClosed = true;
            try {
              controller.close();
            } catch (e) {
              // Controller j√° estava fechado
            }
          }
        };

        try {
          console.log("üì° Iniciando stream real...");
          const reader = response.body?.getReader();
          const decoder = new TextDecoder();

          if (!reader) {
            throw new Error("Stream n√£o dispon√≠vel");
          }

          while (true) {
            const { done, value } = await reader.read();
            
            if (done) {
              if (!isClosed) {
                controller.enqueue(encoder.encode("data: [DONE]\n\n"));
                closeController();
                console.log("‚úÖ Stream finalizado!");
              }
              break;
            }

            const chunk = decoder.decode(value);
            const lines = chunk.split("\n");

            for (const line of lines) {
              if (isClosed) break;
              
              if (line.startsWith("data: ")) {
                const data = line.slice(6);
                if (data === "[DONE]") {
                  if (!isClosed) {
                    controller.enqueue(encoder.encode("data: [DONE]\n\n"));
                    closeController();
                    console.log("‚úÖ Stream finalizado!");
                  }
                  return;
                }

                try {
                  const parsed = JSON.parse(data);
                  const content = parsed.choices?.[0]?.delta?.content;
                  if (content && !isClosed) {
                    const data = `data: ${JSON.stringify({ content })}\n\n`;
                    controller.enqueue(encoder.encode(data));
                  }
                } catch (e) {
                  // Ignora erros de parsing
                }
              }
            }
          }
        } catch (error) {
          console.error("‚ùå Erro no stream:", error);
          if (!isClosed) {
            try {
              controller.error(error);
            } catch (e) {
              // Controller j√° estava fechado
            }
          }
        }
      },
    });

    return new Response(stream, {
      headers: {
        "Content-Type": "text/event-stream",
        "Cache-Control": "no-cache",
        Connection: "keep-alive",
      },
    });
  } catch (error) {
    console.error("‚ùå Erro geral:", error);
    return new Response(
      "Erro interno: " +
        (error instanceof Error ? error.message : String(error)),
      { status: 500 }
    );
  }
}
